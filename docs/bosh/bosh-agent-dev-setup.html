<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>BOSH Agent Development Setup &#8212; my.sphinx  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BOSH linux stemcell builder" href="bosh-stemcell-builder.html" />
    <link rel="prev" title="mockery" href="../golang/mockery.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="bosh-agent-development-setup">
<h1>BOSH Agent Development Setup<a class="headerlink" href="#bosh-agent-development-setup" title="Link to this heading">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PATH=.../s3cli/out:$PATH bin/run -P ubuntu -C path_to_config.json
</pre></div>
</div>
<section id="running-locally">
<h2>Running locally<a class="headerlink" href="#running-locally" title="Link to this heading">¶</a></h2>
<p>To start server locally:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gem install nats
nats-server
</pre></div>
</div>
<p>To subscribe:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nats-sub &#39;&gt;&#39; -s nats://localhost:4222
</pre></div>
</div>
<p>To publish:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nats-pub agent.123-456-789 &#39;{&quot;method&quot;:&quot;apply&quot;,&quot;arguments&quot;:[{&quot;packages&quot;:[{&quot;name&quot;:&quot;package-name&quot;, &quot;version&quot;:&quot;package-version&quot;}]}]}&#39; -s nats://localhost:4222
</pre></div>
</div>
</section>
<section id="blobstores">
<h2>Blobstores<a class="headerlink" href="#blobstores" title="Link to this heading">¶</a></h2>
<p>The Go Agent ships with 4 default blobstores:</p>
<ul class="simple">
<li><p>Local filesystem</p></li>
<li><p>S3</p></li>
<li><p>DAV</p></li>
<li><p>Dummy (for testing)</p></li>
</ul>
<p>You can, however, use custom blobstores by implementing a simple interface. For example, if you want to use a blobstore named “custom” you need to create an executable named <code class="docutils literal notranslate"><span class="pre">bosh-blobstore-custom</span></code> somewhere in <code class="docutils literal notranslate"><span class="pre">PATH</span></code>. This executable must conform to the following command line interface:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-c</span></code> flag that specifies a config file path (this will be passed to every call to the executable)</p></li>
<li><p>must parse the config file in JSON format</p></li>
<li><p>must respond to <code class="docutils literal notranslate"><span class="pre">get</span> <span class="pre">&lt;blobID&gt;</span> <span class="pre">&lt;filename&gt;</span></code> by placing the file identified by the blobID into the filename specified</p></li>
<li><p>must respond to <code class="docutils literal notranslate"><span class="pre">put</span> <span class="pre">&lt;filename&gt;</span> <span class="pre">&lt;blobID&gt;</span></code> by storing the file at filename into the blobstore at the specified blobID</p></li>
</ul>
<p>A full call might look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bosh-blobstore-custom -c /var/vcap/bosh/etc/blobstore-custom.json get 2340958ddfg /tmp/my-cool-file
</pre></div>
</div>
</section>
<section id="set-up-a-workstation-for-development">
<h2>Set up a workstation for development<a class="headerlink" href="#set-up-a-workstation-for-development" title="Link to this heading">¶</a></h2>
<p>Note: This guide assumes a few things:</p>
<ul class="simple">
<li><p>You have gcc (or an equivalent)</p></li>
<li><p>You can install packages (brew, apt-get, or equivalent)</p></li>
</ul>
<p>Get Golang and its dependencies (Mac example, replace with your package manager of choice):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">update</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">go</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">git</span></code> (Go needs git for the <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span></code> command)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">hg</span></code> (Go needs mercurial for the <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span></code> command)</p></li>
</ul>
<p>Clone and set up the BOSH Agent repository:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span> <span class="pre">-d</span> <span class="pre">github.com/cloudfoundry/bosh-agent</span></code></p>
<ul>
<li><p>Note that this will print an error message because it expects a single package; our repository consists of several packages.
The error message is harmless—the repository will still be checked out.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">$GOPATH/src/github.com/cloudfoundry/bosh-agent</span></code></p></li>
</ul>
<p>From here on out we assume you’re working in <code class="docutils literal notranslate"><span class="pre">$GOPATH/src/github.com/cloudfoundry/bosh-agent</span></code></p>
<p>Install tools used by the BOSH Agent test suite:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bin/go</span> <span class="pre">get</span> <span class="pre">code.google.com/p/go.tools/cmd/vet</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bin/go</span> <span class="pre">get</span> <span class="pre">github.com/golang/lint/golint</span></code></p></li>
</ul>
<section id="updating-dependencies">
<h3>Updating dependencies<a class="headerlink" href="#updating-dependencies" title="Link to this heading">¶</a></h3>
<p>All dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">update</span><span class="o">-</span><span class="n">dep</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cloudfoundry</span><span class="o">/</span><span class="n">bosh</span><span class="o">-</span><span class="n">utils</span><span class="o">/...</span>
</pre></div>
</div>
<p>An example for a single dependency:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">update</span><span class="o">-</span><span class="n">dep</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pivotal</span><span class="o">-</span><span class="n">golang</span><span class="o">/</span><span class="n">clock</span><span class="o">/</span><span class="n">fakeclock</span>
</pre></div>
</div>
<p>The script will pull latest package version and copy its files to vendor directory. Note, that it does not pull dependecies recursively from package unless they are vendored.</p>
<p>For development purposes, delete package from vendor use it from your $GOPATH. Once everything works in other package push changes in that package to github and run ./update-dep to add latest version.</p>
<p>Every vendored packaged is recorded in deps.txt with git/hg sha of the package for references. The known issue if subpackages are being vendored and later full package is being vendored subpackage references are not deleted in deps.txt.</p>
<p>To delete package  <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">vendor/path_to_package</span></code> and delete reference in deps.txt.</p>
</section>
<section id="running-tests">
<h3>Running tests<a class="headerlink" href="#running-tests" title="Link to this heading">¶</a></h3>
<p>Each package in the agent has its own unit tests. You can run all unit tests with <code class="docutils literal notranslate"><span class="pre">bin/test-unit</span></code>.</p>
<p>Additionally, <a class="reference external" href="https://github.com/cloudfoundry/bosh">BOSH</a> includes integration tests that use this agent.
Run <code class="docutils literal notranslate"><span class="pre">bin/test-bosh-integration</span></code> to run those with your local agent changes.
However, in order to run the BOSH integrations tests, you will need a copy of the BOSH repo, which this script will do in <code class="docutils literal notranslate"><span class="pre">./tmp</span></code>.
BOSH uses Ruby for its tests, so you will also need to have that available.</p>
<p>You can run all the tests by running <code class="docutils literal notranslate"><span class="pre">bin/test</span></code>.</p>
<p>There is a stand-alone <em>BOSH Agent</em> integration test to test config-drive using bosh-lite. This can be run locally via <code class="docutils literal notranslate"><span class="pre">bin/test-integration</span> <span class="pre">--provider=virtualbox</span></code>. The vagrant provider passed in can be changed to a provider of your choosing if you so desire.</p>
</section>
<section id="using-intellij-with-go-and-the-bosh-agent">
<h3>Using IntelliJ with Go and the BOSH Agent<a class="headerlink" href="#using-intellij-with-go-and-the-bosh-agent" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Install <a class="reference external" href="http://www.jetbrains.com/idea/download/index.html">IntelliJ 15</a></p></li>
<li><p>Install the latest <a class="reference external" href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin">Google Go plugin for IntelliJ</a>. You may want to grab the latest early access (EAP) build, rather than the last release.</p></li>
<li><p>(Optional) Download, Install &amp; Select <a class="reference external" href="https://github.com/Pivotal-Boulder/IDE-Preferences">improved keybindings</a> for IntelliJ:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:Pivotal-Boulder/IDE-Preferences.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/Library/Preferences/IntelliJIdea13/keymaps</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-sf</span> <span class="pre">~/workspace/IDE-Preferences/IntelliJKeymap.xml</span></code></p></li>
<li><p>In IntelliJ: Preferences -&gt; Keymap -&gt; Pick ‘Mac OS X 10.5+ Improved’</p></li>
</ul>
</li>
<li><p>Clone bosh-agent into a clean go workspace (or use a <a class="reference external" href="https://github.com/cloudfoundry/bosh">bosh</a> clone with bosh/go as the workspace root):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">~/workspace/bosh-agent-workspace/src/github.com/cloudfoundry</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/workspace/bosh-agent-workspace/src/github.com/cloudfoundry</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/cloudfoundry/bosh-agent</span></code></p></li>
</ul>
</li>
<li><p>Open ~/workspace/bosh-agent-workspace as a new project in IntelliJ.</p></li>
<li><p>Set the Go SDK as the Project SDK:</p>
<ul>
<li><p>Open the Project Structure window: <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">-&gt;</span> <span class="pre">Project</span> <span class="pre">Structure</span></code></p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Project</span></code> tab in left sidebar</p></li>
<li><p>(Optional) Add a <code class="docutils literal notranslate"><span class="pre">New</span></code> Go SDK by selecting your go root.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Go</span> <span class="pre">SDK</span> <span class="pre">go1.3</span></code> under Project SDK</p></li>
</ul>
</li>
<li><p>Setup module sources</p>
<ul>
<li><p>Open the Project Structure window: <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">-&gt;</span> <span class="pre">Project</span> <span class="pre">Structure</span></code></p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Modules</span></code> tab in left sidebar</p></li>
<li><p>Select your module in the middle sidebar</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Sources</span></code> tab in the Module pane</p></li>
<li><p>Select ~/workspace/bosh-agent-workspace/src and add is as a source dir</p></li>
</ul>
</li>
<li><p>Install &amp; configure the <a class="reference external" href="https://github.com/krasa/GrepConsole">Grep Console</a> plugin</p>
<ul>
<li><p>Install via <code class="docutils literal notranslate"><span class="pre">Preferences</span> <span class="pre">-&gt;</span> <span class="pre">Plugins</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Preferences</span> <span class="pre">-&gt;</span> <span class="pre">Grep</span> <span class="pre">COnsole</span> <span class="pre">-&gt;</span> <span class="pre">Enable</span> <span class="pre">ANSI</span> <span class="pre">coloring</span></code> to colorize Ginkgo test output</p></li>
</ul>
</li>
<li><p>Re-index your project: <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">-&gt;</span> <span class="pre">Invalidate</span> <span class="pre">Cache</span> <span class="pre">/</span> <span class="pre">Restart</span></code></p></li>
</ul>
<p>You should now be able to ‘go to declaration’, auto-complete, and run tests from within IntelliJ.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">my.sphinx</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../golang/mockery.html">mockery</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">BOSH Agent Development Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="bosh-stemcell-builder.html">BOSH linux stemcell builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="bosh-lite-resizing.html">BOSH lite resizing</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-upstart.html">Using upstart on ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="reverse-ssh-port-forwarding.html">Bypassing corporate firewall with reverse ssh port forwarding</a></li>
<li class="toctree-l1"><a class="reference internal" href="bosh-task.html">BOSH task</a></li>
<li class="toctree-l1"><a class="reference internal" href="bosh-inside.html">BOSH Inside</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-01-openstack.html">OpenStack Case 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-02-openstack.html">OpenStack Case 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-03-aws.html">Case 3 AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-04-aws.html">Case 4 AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-05-galera-cluster.html">IaaS 네트워크 장비 교체 작업 후 mariadb galera cluster 장애</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot-case-06-openstack.html">Trouble Shoot case 6 OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/locket.html">Locket</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/cups.html">Custom User Provided Service (CUPS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch3.html">CF-Extensions projects in incubation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.1.html">Custom User Provided Service (CUPS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.2.html">Cloud Native Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.3.html">Failed to push java app (case sensative entries)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.4.html">bosh-lite 장애 Case 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.5.html">Heartbeat Message sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.6.html">BOSH2 CLI 로 VM 에 로그인 하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.7.html">HowTo Simply TcpDump and get.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.8.html">Inside Cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.9.html">Inside Diego Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.10.html">Router Register Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.11.html">Cloud Check 를 통한 vm 장애 복구</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.12.html">bosh-init 시 Open Stack Nova Bug 관련</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.13.html">cf-openstack-validator 실행시 floatingip 관련 오류</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cf/ch1.z.html">Uncategorized</a></li>
<li class="toctree-l1"><a class="reference internal" href="../os/ch1.1.html">Chapter 1 Command-Line Interface (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../os/ch1.1.html#uncategorized">Uncategorized</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/git-flow.html">git flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/git-push.html">git push</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/git-status.html">git status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../md/markdown_examples.html">Markdown Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../md/markdown_examples.html#an-h1-header">An h1 header</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../golang/mockery.html" title="previous chapter">mockery</a></li>
      <li>Next: <a href="bosh-stemcell-builder.html" title="next chapter">BOSH linux stemcell builder</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2017, me.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/bosh/bosh-agent-dev-setup.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>