#!/usr/bin/env python3
"""
Sphinx documentation build script with isolated virtual environment.
"""
import subprocess
import sys
import shutil
from pathlib import Path


def run_command(cmd, cwd=None, check=True):
    """Run a shell command and print output."""
    print(f"Running: {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=cwd, check=check)
    return result


def main():
    # Get project root directory (parent of bin/)
    project_root = Path(__file__).parent.parent
    venv_dir = project_root / ".venv"
    
    # Determine venv paths based on platform
    if sys.platform == "win32":
        venv_python = venv_dir / "Scripts" / "python.exe"
        venv_pip = venv_dir / "Scripts" / "pip.exe"
        venv_sphinx = venv_dir / "Scripts" / "sphinx-build.exe"
    else:
        venv_python = venv_dir / "bin" / "python"
        venv_pip = venv_dir / "bin" / "pip"
        venv_sphinx = venv_dir / "bin" / "sphinx-build"
    
    try:
        # Step 1: Create virtual environment
        print("\nüì¶ Creating virtual environment...")
        run_command([sys.executable, "-m", "venv", str(venv_dir)])
        
        # Step 2: Install dependencies
        print("\nüì• Installing dependencies...")
        run_command([str(venv_pip), "install", "-r", "requirements.txt"], cwd=project_root)
        
        # Step 3: Build documentation
        print("\nüî® Building documentation...")
        run_command([
            str(venv_sphinx),
            "-b", "html",
            "src",
            "docs"
        ], cwd=project_root)
        
        # Step 4: Create .nojekyll file for GitHub Pages
        print("\nüìÑ Creating .nojekyll file...")
        nojekyll_file = project_root / "docs" / ".nojekyll"
        nojekyll_file.touch()
        
        # Step 5: Clean up
        print("\nüßπ Cleaning up virtual environment...")
        shutil.rmtree(venv_dir)
        
        print("\n‚úÖ Build complete! Documentation is in docs/")
        print("\nTo commit and push, run:")
        print("  git add -A")
        print("  git commit -m 'Build and update documentation'")
        print("  git push")
        
        return 0
        
    except subprocess.CalledProcessError as e:
        print(f"\n‚ùå Error: Command failed with exit code {e.returncode}", file=sys.stderr)
        if venv_dir.exists():
            print("üßπ Cleaning up virtual environment...", file=sys.stderr)
            shutil.rmtree(venv_dir)
        return 1
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è  Build interrupted by user", file=sys.stderr)
        if venv_dir.exists():
            print("üßπ Cleaning up virtual environment...", file=sys.stderr)
            shutil.rmtree(venv_dir)
        return 130
    except Exception as e:
        print(f"\n‚ùå Unexpected error: {e}", file=sys.stderr)
        if venv_dir.exists():
            print("üßπ Cleaning up virtual environment...", file=sys.stderr)
            shutil.rmtree(venv_dir)
        return 1


if __name__ == "__main__":
    sys.exit(main())

